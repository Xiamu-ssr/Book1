---
description: Google File System浅读，标注
---

# GFS

## 1.INTRODUCTION

首先，组件故障是常态，而不是例外。因此，持续监控、错误检测、容错和自动恢复必须是系统的组成部分。其次，大多数文件是通过附加新数据而不是覆盖现有数据来改变的。

## 2.DESIGN OVERVIEW

### 2.3Architecture

chunkserver（DataNode）将块以Linux文件的形式存储在本地磁盘上，默认情况下，我们存储三个副本。而主服务器（NameNode）主服务器维护所有文件系统元数据。主服务器定期与心跳消息中的每个chunkserver通信，给它指令并收集它的状态。

### 2.4Single Master

客户端从不通过主服务器读写文件数据。相反，客户端询问主服务器它应该联系哪个块服务器。它将这些信息缓存一段有限的时间，并直接与chunkserver交互以进行许多后续操作。这样可以减轻主服务器的负担。

### 2.5Chunk Size

GFS块大小采用64MB，比一般的文件系统大的多。这有诸多好处，首先，它减少了客户端与主机交互的需要，因为块变大，交互次数减少。其次，由于在较大的数据块上，客户机更有可能在给定的数据块上执行许多操作，因此可以通过保持持久化来减少网络开销。第三，它减少了存储在主服务器上的元数据的大小，这意味着集群存储上限更高。

### 2.6Metadata

#### 2.6.1In-Memory Data Structures

由于元数据存储在内存中，所以主操作速度很快。此外，主服务器可以在后台周期性地扫描其整个状态，这既简单又有效。这种周期性扫描用于实现块垃圾收集、块服务器出现故障时的重新复制，以及平衡负载和磁盘空间的块迁移

#### 2.6.2Chunk Locations

我们认为在启动时从chunkserver请求数据要简单得多，此后定期请求数据。这消除了保持主服务器和块服务器同步的问题，这种问题在拥有数百台服务器的集群中经常发生。另一个方面是因为认识到，chunkserver对它自己的磁盘上有什么块或没有什么块拥有最终决定权。

#### 2.6.3Operation Log

这段话是关于GFS的操作日志的管理和恢复。它有以下逻辑结构：

* 主题句：操作日志包含了关键的元数据变化的历史记录，是GFS的核心。
* 操作日志的作用：是唯一的元数据持久化记录，也是定义并发操作顺序的逻辑时间线。
* 操作日志的存储方式：在多个远程机器上复制，并在本地和远程都刷盘后才响应客户端操作。
* 操作日志的优化方式：批量刷盘，减少刷盘和复制对系统吞吐量的影响。
* 操作日志的恢复方式：通过重放操作日志来恢复主节点的文件系统状态。
* 操作日志的缩减方式：当日志超过一定大小时，主节点生成状态快照，并在本地和远程保存。
* 状态快照的管理方式：只需要最新的完整快照和后续的日志文件，旧的快照和日志文件可以删除，但保留一些以防灾难。如果生成快照时发生故障，不影响正确性，因为恢复代码可以检测并跳过不完整的快照。

### 2.7Consistency Model

讲述了文件命名空间变化是原子的，由主节点独占处理以及数据变化后不同状态的对应的措施，确保文件变化不冲突或错误。

## 4.MASTER OPERATION

### 4.2Replica Placement

副本策略有两个好处 1.可靠性2.提高带宽&#x20;

副本放置到多个机架还有好处就是，利用多个机架总带宽；当整个机架脱机，数据仍可以被访问。

### 4.3Creation, Re-replication, Rebalancing

块副本是由于三个原因而创建的：块创建，重复制和重平衡。

具体来说，GFS在创建块副本时会考虑以下三个因素：

1. 磁盘利用率：GFS会优先选择磁盘利用率低于平均值的块服务器来存储新的块副本，以实现磁盘空间的均衡利用。
2. 块服务器负载：GFS会限制每个块服务器上“最近”创建的块副本数量，以避免出现过多的写流量。
3. 块副本的分布：GFS希望将块副本分布在不同的机架上，以提高系统的容错性和可用性。

在重新复制块副本时，GFS会优先考虑距离目标复制数最远的块副本，并优先复制那些属于活动文件的块副本。为了最小化运行应用程序的影响，GFS还会提高阻塞客户端进度的块副本的优先级。

最后，GFS还通过定期重新平衡块副本的分布来实现磁盘空间和负载均衡，同时逐步填充新的块服务器。在这个过程中，GFS会选择要移动的块副本和移动到哪里，以实现磁盘空间的均衡利用。具体来说，GFS会移动那些在磁盘空间利用率低于平均值的块服务器上的块副本，以达到磁盘空间的均衡利用。

### 4.4Garbage Collection

在GFS中，文件被删除后，并不会立即回收可用的物理存储空间，而是在定期的垃圾回收过程中进行惰性回收，这种做法使得系统更加简单和可靠。当应用程序删除文件时，主节点会立即记录删除操作，但不会立即回收资源，在主节点定期扫描文件系统命名空间时，删除遗留超过三天的文件。当文件从命名空间中删除时，其内存中的元数据被删除。每个块服务器定期向主节点发送心跳消息，报告它所拥有的一部分块，主节点则回复所有不再其元数据中的块的标识。块服务器可以自由地删除这些块的副本。这种垃圾回收的方式相对于立即删除具有以下优点：首先，它是在大规模分布式系统中简单和可靠的清理未知是否有用的副本的方式；其次，它将存储空间回收合并到主节点的常规后台活动中，并且成本被分摊，同时只在主节点相对空闲时执行，以使其能够更快地响应需要及时处理的客户端请求；最后，回收存储空间的延迟提供了一种安全保护措施，避免了意外、不可逆的删除。

## 5.FAULT TOLERANCE AND DIAGNOSIS

在质量和数量的双重挤压下，机器的各种故障将成为常态。我们将讨论这些挑战。

### 5.1High Availability

我们通过两种简单而有效的策略来保持整个系统的高可用性:快速恢复和复制。

快速启动：主服务器和chunkserver都被设计成可以在几秒钟内恢复它们的状态并启动，无论它们如何终止。

块复制：当chunkserver脱机或通过校验和验证检测损坏的副本时，主服务器根据需要克隆现有副本以保持每个块的完全复制

主节点复制：复制主状态是为了提高可靠性。它的操作日志和检查点被复制到多台机器上。当它fails时，它几乎可以立即重新启动。

### 5.2Data Integrity

数据在传输路径上很可能出现数据不完整的情况。

一个块被分解成64 KB的块，每个都有一个相应的32位校验和。在返回数据之前，checkserver会检验数据完整性，如果出现问题，它会向请求者发送错误信号，并向主节点报告。作为回应，请求端会从其他服务器获得副本，而主节点会从其他服务器复制一份有效的副本来覆盖这份有问题的。

校验和对读性能的影响很小。

### 5.3Diagnostic Tools

广泛而详细的诊断日志记录在问题隔离、调试和性能分析方面提供了不可估量的帮助，同时只产生最小的成本。通过将请求与应答进行匹配并整理不同机器上的RPC记录，我们可以重建整个交互历史以诊断问题。日志还可以作为负载测试和性能分析的跟踪。

## 6.MEASUREMENTS

提出了一些微型基准测试和结果

## 7.EXPERIENCES

滴水穿石非一日之功，讲述了项目过程更多细节，冲突，优化，创新。

## 8.总结

首先，考虑了成本问题，假设集群都是由低端机组成，所以故障将成为常态，以此又提出应对策略。

然后，是集群高可用性，也就是自动解决故障方案，在使用过程让使用者感觉到高可靠，高稳定。

然后，是集群高扩展性，datanode存块，namenode存元数据，只要namenode内存够大，集群理论可以一直扩展下去。

最后，由于各种优化措施，性能也很不错。

